# Define role trong Keystone
## 1. File policy.json
- Mỗi dịch vụ Openstack như `Identity`, `compute` hay `networking` đều có riêng `role-based access policies`.
- Các `role` này xác định user nào có quyền truy cập tới `object` nào và bằng cách nào.
- Những policy này được định nghĩa ở trong file `policy.json`.
- Môi khi API gọi tới 1 dịch vụ nào đó, `policy engine` sẽ sử dụng các policy đã được `define` để xác định xem API call đó có hợp lệ không.
- Bất cứ sự thay đổi nào đối với file `policy.json` sẽ có tác dụng ngay lập tức, cho phép policy mới có thể được thực thi ngay khi service vẫn đang chạy.
- `/etc/keystone/keystone.policy.yaml `
- File `policy.json` là file text định dạng Json. Mỗi policy được định nghĩa trong 1 dòng theo form:
   + `"<target>" : "<rule>"`
   + `Target` ở đây được hiểu là các actions, là các API call để tạo máy ảo, gán volume.

## 2. Cấu trúc
```
{
	"<rule>": "define rule",

	
	"<target>": "<rule> or <role>"
}
```
- File `policy.json` bao gồm các policis và alias theo form sau:
```
{
      "alias 1" : "definition 1",
      "alias 2" : "definition 2",
      ...
      "target 1" : "rule 1",
      "target 2" : "rule 2",
      ....
}
```
- `target` là các API được viết dưới dạng `"service:API"` hoặc đơn giản chỉ là `API`. 
    + Ex: `"identity:get_access_token"`, `"identity:list_access_tokens"`
- `rule` sẽ xác định API call có hợp lệ hay không.

## 3. LAB
- Yêu cầu: 
   + Tạo user `khanh_new`, project `khanh_project` trong domain `khanh_domain`
   + Tạo 1 role tên `khanh_role` cho user `khanh_new` có thể  list các user.
- **Create domain**
```
root@controller:~# openstack domain create khanh_domain
+-------------+----------------------------------+
| Field       | Value                            |
+-------------+----------------------------------+
| description |                                  |
| enabled     | True                             |
| id          | 35e824da23944c3fbb9b35f6f0cbabc5 |
| name        | khanh_domain                     |
| tags        | []                               |
+-------------+----------------------------------+
root@controller:~# openstack domain list
+----------------------------------+--------------+---------+--------------------+
| ID                               | Name         | Enabled | Description        |
+----------------------------------+--------------+---------+--------------------+
| 35e824da23944c3fbb9b35f6f0cbabc5 | khanh_domain | True    |                    |
| 6b18f4fae9cc453e87fc5a98f37b39c4 | newdomain    | True    |                    |
| b5c4fcc79192459c82c02cf42ff34eee | new_domain   | True    |                    |
| default                          | Default      | True    | The default domain |
| fd26194fab694233a040d07e227abc81 | example      | True    | An Example Domain  |
+----------------------------------+--------------+---------+--------------------+
```
- **Create user `khanh_new` and project `khanh_project`**
```
root@controller:~# openstack project create --domain khanh_domain --description "khanh_project in khanh_domain" khanh_project
+-------------+----------------------------------+
| Field       | Value                            |
+-------------+----------------------------------+
| description | khanh_project in khanh_domain    |
| domain_id   | 35e824da23944c3fbb9b35f6f0cbabc5 |
| enabled     | True                             |
| id          | 958d8dddb18b4519a7897fa58b96b918 |
| is_domain   | False                            |
| name        | khanh_project                    |
| parent_id   | 35e824da23944c3fbb9b35f6f0cbabc5 |
| tags        | []                               |
+-------------+----------------------------------+
root@controller:~# openstack project list --domain khanh_domain
+----------------------------------+---------------+
| ID                               | Name          |
+----------------------------------+---------------+
| 958d8dddb18b4519a7897fa58b96b918 | khanh_project |
```

```
root@controller:~# openstack user create --domain khanh_domain khanh_new --password corgi1208
+---------------------+----------------------------------+
| Field               | Value                            |
+---------------------+----------------------------------+
| domain_id           | 35e824da23944c3fbb9b35f6f0cbabc5 |
| enabled             | True                             |
| id                  | e77771ae4e9f4513a8c5cd22db757a89 |
| name                | khanh_new                        |
| options             | {}                               |
| password_expires_at | None                             |
+---------------------+----------------------------------+
root@controller:~# openstack user list --domain khanh_domain
+----------------------------------+-----------+
| ID                               | Name      |
+----------------------------------+-----------+
| e77771ae4e9f4513a8c5cd22db757a89 | khanh_new |
+----------------------------------+-----------+
```

- **Create role `khanh_role`**
```
root@controller:~# openstack role create khanh_role
+-----------+----------------------------------+
| Field     | Value                            |
+-----------+----------------------------------+
| domain_id | None                             |
| id        | 17318c81d4cd411d8804e2e69acd13ef |
| name      | khanh_role                       |
+-----------+----------------------------------+
root@controller:~# openstack role list
+----------------------------------+------------+
| ID                               | Name       |
+----------------------------------+------------+
| 0f854f698d94417a83a05e2559a23b18 | reader     |
| 17318c81d4cd411d8804e2e69acd13ef | khanh_role |
| 42c4c15b1e9641ba9c9762bf9e20d3e9 | admin      |
| 89d4ef2a82644f24b1e5274c671c77cc | member     |
| 9525d3fc81fd4252ab0ef9c82d195795 | myrole     |
+----------------------------------+------------+
```

- **Add role `khanh_role` for `khanh_new` user and `khanh_project**

