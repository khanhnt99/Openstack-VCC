# Floating IP DVR Neutron Openstack

- Trong mô hình trước đây, tất cả các lưu lượng truy cập đến từ external đều phải đi qua 1 network node với floating IP.
- Với DVR, cùng 1 lưu lượng có thể không đi qua network node đó mà có thể được định tuyến trực tiếp đến compute node.
- Khi 1 floating IP được gán cho một virtual machine instance, `L3 agent` trên compute node đấy sẽ tạo 1 `fip` namespace.

```
root@compute1:~# ip netns
fip-09363fbd-54d7-451a-b285-63bc524f30da (id: 1)
qrouter-1d514d09-52b8-4d4b-aa47-60489e47a943 (id: 0)
```

- Router namespace trên compute node kết nối với external network  chia sẻ 1 `fip namespace` duy nhất.
- 2 namespace này được connect với nhau thông qua `rfp` và `fpr` interface sử dụng 192.254/16 address space.

```
root@compute1:~# ip netns e qrouter-1d514d09-52b8-4d4b-aa47-60489e47a943 ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: qr-3fc0b79f-a2@if147: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1450 qdisc noqueue state UP group default qlen 1000
    link/ether fa:16:3e:a3:ba:cc brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 172.16.1.1/24 brd 172.16.1.255 scope global qr-3fc0b79f-a2
       valid_lft forever preferred_lft forever
    inet6 fe80::f816:3eff:fea3:bacc/64 scope link tentative dadfailed 
       valid_lft forever preferred_lft forever
3: rfp-1d514d09-5: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000
    link/ether c6:fd:88:b2:ec:f4 brd ff:ff:ff:ff:ff:ff link-netnsid 1
    inet 169.254.106.114/31 scope global rfp-1d514d09-5
       valid_lft forever preferred_lft forever
    inet6 fe80::c4fd:88ff:feb2:ecf4/64 scope link 
       valid_lft forever preferred_lft forever
```

### `Sending traffic from an instance with floating IP`

![](https://i.ibb.co/5kXKcBy/5.png)

- Green VM instance ở địa chỉ 10.30.0.3 gửi traffic tới external resource 

|Src MAC| Dest MAC| Src IP| Dest IP|
|-------|---------|-------|--------|
|Green VM| Green qr interface| Fixed IP| 8.8.8.8|

- Ví dụ instance IP là 172.16.1.4
```
root@compute1:~# ip netns e qrouter-1d514d09-52b8-4d4b-aa47-60489e47a943 ip rule
0:      from all lookup local 
32766:  from all lookup main 
32767:  from all lookup default 
57481:  from 172.16.1.4 lookup 16 
2886729985:     from 172.16.1.1/24 lookup 2886729985 

root@compute1:~# ip netns e qrouter-1d514d09-52b8-4d4b-aa47-60489e47a943 ip route show table 16
default via 169.254.106.115 dev rfp-1d514d09-5 

```

- `qrouter` sẽ NAT fix IP thành floating IP rồi gửi packet tới `fip` namespace.
```
-A neutron-l3-agent-float-snat -s 172.16.1.4/32 -j SNAT --to-source 192.168.10.103
```

![](https://i.ibb.co/SVPxpfh/6.png)

|Src MAC| Dest MAC| Src IP| Dest IP|
|-------|---------|-------|--------|
|rfp interface| fpr interface| floating IP| 8.8.8.8|

- Khi đi ra internet khi có floating IP thì instance sẽ tự động đi qua bằng Floating IP đấy thông qua `FIP namespace`.

- Khi có floating IP thông qua FIP namespace.
![](https://i.ibb.co/C8Cm8L5/Screenshot-from-2021-06-02-15-31-37.png)

- Khi không có floating IP thì thông qua SNAT trên network node.
![](https://i.ibb.co/1vZ11c7/Screenshot-from-2021-06-02-15-38-52.png)

- Rule DNAT và SNAT

```
-A neutron-l3-agent-PREROUTING -d 192.168.10.112/32 -i rfp-1d514d09-5 -j DNAT --to-destination 172.16.1.6
-A neutron-l3-agent-float-snat -s 172.16.1.6/32 -j SNAT --to-source 192.168.10.112
```

### `Returning traffic to the Floating IP`

- Ở DVR, `qrouter` không trực tiếp liên kết tới mạng external network. Nhưng mọi trường hợp SNAT hoặc DNAT đều thực hiện tại router chuyển từ Fix IP sang Floating IP.


#### `Firewall rule`
```
root@dhcp-server:~# cat firewall.rule 
# Generated by iptables-save v1.6.0 on Fri May 28 13:05:46 2021
*filter
:INPUT ACCEPT [7936:522669]
:FORWARD ACCEPT [16096:1551743]
:OUTPUT ACCEPT [7042:3352696]
COMMIT
# Completed on Fri May 28 13:05:46 2021
# Generated by iptables-save v1.6.0 on Fri May 28 13:05:46 2021
*nat
:PREROUTING ACCEPT [1:328]
:INPUT ACCEPT [1:328]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [2:120]
-A PREROUTING -i ens3 -p tcp -m tcp --dport 80 -j DNAT --to-destination 192.168.10.2
-A PREROUTING -i ens3 -p tcp -m tcp --dport 6080 -j DNAT --to-destination 192.168.10.2
-A PREROUTING -i ens3 -p tcp -m tcp --dport 2222 -j DNAT --to-destination 192.168.10.105:22
-A PREROUTING -i ens3 -p tcp -m tcp --dport 9000 -j DNAT --to-destination 192.168.10.105:80
-A POSTROUTING -s 192.168.10.0/24 -o ens3 -j MASQUERADE
COMMIT
# Completed on Fri May 28 13:05:46 2021
```

